# 2.1.2. 内核组织

1.在本节中，我们从两个方面来看待4.4BSD内核的组织。

2.通过其动态操作，根据向用户提供的服务进行分类

内核的最大部分是实现应用程序通过系统调用访问的系统服务。在 4.4BSD 中，这个软件是按照以下方式组织的:

- 基本的内核设施：定时器和系统时钟处理、描述符管理和进程管理

- 内存管理支持：分页和交换

- 通用系统接口：对描述符进行的 I/O、控制和多路复用操作

- 文件系统：文件、目录、路径名转换、文件锁定和 I/O 缓冲区管理

- 终端处理支持：终端接口驱动程序和终端线纪律

- 进程间通信设施：套接字

- 对网络通信的支持：通信协议和通用网络设施，如路由等

表1. 4.4BSD 内核中与机器无关的软件

| Category                       | Lines of code | Percentage of kernel |
| :----------------------------: | :-----------: | :------------------: |
| headers                        | 9,393         | 4.6                  |
| initialization                 | 1,107         | 0.6                  |
| kernel facilities              | 8,793         | 4.4                  |
| generic interfaces             | 4,782         | 2.4                  |
| interprocess communication     | 4,540         | 2.2                  |
| terminal handling              | 3,911         | 1.9                  |
| virtual memory                 | 11,813        | 5.8                  |
| vnode management               | 7,954         | 3.9                  |
| filesystem naming              | 6,550         | 3.2                  |
| fast filestore                 | 4,365         | 2.2                  |
| log-structure filestore        | 4,337         | 2.1                  |
| memory-based filestore         | 645           | 0.3                  |
| cd9660 filesystem              | 4,177         | 2.1                  |
| miscellaneous filesystems (10) | 12,695        | 6.3                  |
| network filesystem             | 17,199        | 8.5                  |
| network communication          | 8,630         | 4.3                  |
| internet protocols             | 11,984        | 5.9                  |
| ISO protocols                  | 23,924        | 11.8                 |
| X.25 protocols                 | 10,626        | 5.3                  |
| XNS protocols                  | 5,192         | 2.6                  |

这些类别中的大多数软件都是独立于机器的，并且可以在不同的硬件架构上移植。

内核中与机器相关的部分与主流代码是隔离的。特别是，独立于机器的代码都不包含特定架构的条件代码。当需要一个依赖架构的动作时，独立于机器的代码会调用位于依赖机器的代码中的依赖架构的函数。依赖机器的软件包括

- 低级别的系统启动动作

- 陷阱和故障处理

- 对一个进程的运行时环境进行低级操作

- 硬件设备的配置和初始化

- 对 I/O 设备的运行时间支持

表2. 4.4BSD 内核中 HP300 的依赖机器的软件

| Category                      | Lines of code | Percentage of kernel |
| :---------------------------- | :------------ | :------------------- |
| machine dependent headers     | 1,562         | 0.8                  |
| device driver headers         | 3,495         | 1.7                  |
| device driver source          | 17,506        | 8.7                  |
| virtual memory                | 3,087         | 1.5                  |
| other machine dependent       | 6,287         | 3.1                  |
| routines in assembly language | 3,014         | 1.5                  |
| HP/UX compatibility           | 4,683         | 2.3                  |

4.4BSD 内核中独立于机器的软件，总结了构成 HP300 的 4.4BSD 内核的独立于机器的软件。第 2 栏中的数字是指 C 源代码、头文件和汇编语言的行数。内核中几乎所有的软件都是用 C 语言编写的，只有不到 2% 是用汇编语言编写的。正如4.4BSD 内核中 HP300 的机器依赖软件的统计数字所示，机器依赖软件，不包括 HP/UX 和设备支持，只占内核的 6.9%。

内核中只有一小部分是用来初始化系统的。这段代码在系统启动运行时使用，负责设置内核的硬件和软件环境（见第 14 章）。一些操作系统（特别是那些物理内存有限的操作系统）在执行这些功能的软件后，会丢弃或叠加该软件。4.4BSD 内核没有回收启动代码所使用的内存，因为该内存空间几乎不占典型机器上使用的内核资源的 0.5%。而且，启动代码并不出现在内核的某个地方--它分散在各个地方，而且通常出现在与被初始化的东西有关的逻辑上。
