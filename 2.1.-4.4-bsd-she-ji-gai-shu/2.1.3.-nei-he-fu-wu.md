# 2.1.3. 内核服务

内核和用户级代码之间的界限是由底层硬件提供的硬件保护设施强制执行的。内核在一个独立的地址空间中运行，用户进程无法进入。特权操作——如启动 I/O 和停止中央处理单元（CPU）——只对内核可用。应用程序通过系统调用向内核请求服务。系统调用被用来使内核执行复杂的操作，如将数据写入二级存储，以及简单的操作，如返回当前时间。所有的系统调用对应用程序来说都是同步的。当内核进行与系统调用相关的操作时，应用程序不会运行。内核可能在系统调用返回后完成一些与之相关的操作。例如，一个写系统调用会在用户进程等待时将要写入的数据复制到内核缓冲区，但通常会在内核缓冲区被写入磁盘之前从系统调用中返回。

系统调用通常被实现为一个硬件陷阱，它改变了 CPU 的执行模式和当前的地址空间映射。用户在系统调用中提供的参数在使用前会被内核验证。这种检查保证了系统的完整性。所有传入内核的参数都被复制到内核的地址空间，以确保经过验证的参数不会因为系统调用的副作用而改变。系统调用的结果由内核返回，或者在硬件寄存器中，或者通过它们的值被复制到用户指定的内存地址。和传递到内核的参数一样，用于返回结果的地址必须经过验证，以确保它们是应用程序地址空间的一部分。如果内核在处理一个系统调用时遇到错误，它会向用户返回一个错误代码。对于 C 语言来说，这个错误代码被保存在全局变量 errno 中，而执行系统调用的函数返回值为`-1`。

用户应用程序和内核的运行是相互独立的。4.4BSD 不在应用程序的地址空间中存储I/O控制块或其他操作系统相关的数据结构。每个用户级应用程序都有一个独立的地址空间，它在其中执行。内核使大多数的状态变化，如在另一个进程运行时暂停一个进程，对所涉及的进程是不可见的。
